#!/usr/bin/env python3
import rospy
import cv2
import numpy as np
import time
from sensor_msgs.msg import CompressedImage, LaserScan
from geometry_msgs.msg import Twist
from cv_bridge import CvBridge

class LimoFinalController:
    def __init__(self):
        rospy.init_node("limo_final_controller")

        self.cmd_pub = rospy.Publisher("/cmd_vel", Twist, queue_size=1)
        rospy.Subscriber("/usb_cam/image_raw/compressed", CompressedImage, self.cam_cb)
        rospy.Subscriber("/scan", LaserScan, self.lidar_cb)

        self.bridge = CvBridge()

        # =====================
        # 파라미터
        # =====================
        self.BASE_SPEED = 0.15
        self.KP_LANE = 0.004
        self.KP_CENTER = 0.006

        self.NORMAL_LANE_WIDTH = 160
        self.WIDE_LANE_THRESHOLD = 1.4 * self.NORMAL_LANE_WIDTH

        self.FRONT_OBS_DIST = 0.45

        # =====================
        # 상태
        # =====================
        self.state = "LANE_FOLLOW"
        self.current_mission = 1

        self.lane_width = None
        self.lane_center_error = 0

        self.front_dist = 999
        self.centering_start_time = None

    # =====================
    # Camera Callback
    # =====================
    def cam_cb(self, msg):
        img = self.bridge.compressed_imgmsg_to_cv2(msg)
        h, w, _ = img.shape
        roi = img[int(h*0.6):h, :]

        gray = cv2.cvtColor(roi, cv2.COLOR_BGR2GRAY)
        _, binary = cv2.threshold(gray, 200, 255, cv2.THRESH_BINARY)

        hist = np.sum(binary, axis=0)

        left = np.argmax(hist[:w//2])
        right = np.argmax(hist[w//2:]) + w//2

        self.lane_width = right - left
        lane_center = (left + right) / 2
        self.lane_center_error = (w / 2) - lane_center

    # =====================
    # LiDAR Callback
    # =====================
    def lidar_cb(self, msg):
        ranges = np.array(msg.ranges)
        front = ranges[len(ranges)//2 - 10 : len(ranges)//2 + 10]
        self.front_dist = np.min(front)

    # =====================
    # Control Loop
    # =====================
    def run(self):
        rate = rospy.Rate(20)
        while not rospy.is_shutdown():
            cmd = Twist()

            # =====================
            # 공통 속도
            # =====================
            cmd.linear.x = self.BASE_SPEED

            # =====================
            # 미션 3 중앙 유지 (핵심)
            # =====================
            if self.current_mission == 3:
                if self.state == "LANE_FOLLOW" and self.lane_width and self.lane_width > self.WIDE_LANE_THRESHOLD:
                    self.state = "M3_ENTRY_CENTERING"
                    self.centering_start_time = time.time()

                if self.state == "M3_ENTRY_CENTERING":
                    cmd.angular.z = self.KP_CENTER * self.lane_center_error

                    if time.time() - self.centering_start_time > 0.8:
                        self.state = "M3_OBSTACLE_AVOID"

                elif self.state == "M3_OBSTACLE_AVOID":
                    if self.front_dist < self.FRONT_OBS_DIST:
                        cmd.angular.z = 0.6   # 회전
                        cmd.linear.x = 0.0
                    else:
                        cmd.angular.z = 0.0

            # =====================
            # 미션 6 (좁은 통로) – 중앙 유지 절대 금지
            # =====================
            elif self.current_mission == 6:
                if self.front_dist < self.FRONT_OBS_DIST:
                    cmd.angular.z = 0.5
                    cmd.linear.x = 0.0
                else:
                    cmd.angular.z = self.KP_LANE * self.lane_center_error

            # =====================
            # 일반 차선 주행 (1,2,4,5)
            # =====================
            else:
                cmd.angular.z = self.KP_LANE * self.lane_center_error

            self.cmd_pub.publish(cmd)
            rate.sleep()

if __name__ == "__main__":
    controller = LimoFinalController()
    controller.run()
